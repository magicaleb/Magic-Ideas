<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b1020">
  <title>Swipe — Perform</title>
  <link rel="stylesheet" href="../../assets/css/base.css?v=2">
  <style>
    /* Reset and override any base.css conflicts for PWA */
    html, body { 
      margin:0 !important; 
      padding:0 !important; 
      height:100vh !important;
      min-height:100vh !important;
      background:var(--bg) !important;
      overflow:hidden !important;
    }
    
    /* perform layout: full-bleed behind status bar, respect safe areas for content */
    .perform-root{
      position:fixed !important;
      top:0 !important;
      left:0 !important;
      right:0 !important;
      bottom:0 !important;
      width:100vw !important;
      height:100vh !important;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      background:var(--bg);
      touch-action:none;
      -webkit-user-select:none;
      user-select:none;
      z-index:1;
    }
    .digits-wrap{display:flex;align-items:center;justify-content:center;pointer-events:none}
    .digits{font-size:4.4rem;letter-spacing:6px;color:rgba(255,255,255,0.95);font-weight:800}
    .last{position:fixed;bottom:calc(8px + env(safe-area-inset-bottom));left:12px;color:rgba(255,255,255,0.7);font-size:0.9rem}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14vh;background:#0f1733;border:1px solid #2a386c;color:var(--text);padding:8px 12px;border-radius:10px;display:none}
    .flash{animation:flash 240ms ease}
    @keyframes flash{0%{transform:scale(1)}50%{transform:scale(0.96)}100%{transform:scale(1)}}
    
    /* Simplified fake homescreen background - full bleed for PWA */
    .fake-homescreen{
      position:fixed !important;
      top:0 !important;
      left:0 !important;
      right:0 !important;
      bottom:0 !important;
      width:100vw !important;
      height:100vh !important;
      background-size:cover !important;
      background-position:center !important;
      background-repeat:no-repeat !important;
      pointer-events:none !important;
      z-index:0 !important;
      display:none !important;
    }
    
    /* When fake homescreen is active, make root background transparent */
    .perform-root.fake-active{background:transparent !important}
  </style>
  </style>
</head>
<body>
  <div id="fakeHomescreen" class="fake-homescreen"></div>
  <div id="root" class="perform-root" role="application">
    <div class="digits-wrap">
      <div id="digits" class="digits" aria-live="polite">—</div>
    </div>
  <div id="last" class="last">—</div>
    <div id="toast" class="toast" aria-hidden="true">Saved</div>
  </div>

  <script src="../../assets/js/storage.js"></script>
  <script src="../../assets/js/gestures.js"></script>
  <script src="../../assets/js/swipe.js"></script>
  <script>
    // Clean, final Perform page wiring — uses existing Storage, Gestures and Swipe modules.
    const root = document.getElementById('root');
    const digitsEl = document.getElementById('digits');
    const lastEl = document.getElementById('last');
    const toast = document.getElementById('toast');
    const fakeHomescreen = document.getElementById('fakeHomescreen');

    const defaults = { delay:3, shortcut:'', clipboard:false, postShortcut:'', fakeHomescreen:false, homescreenImage:'' };
    let cfg = Storage.load('swipe', defaults);
    
    console.log('Initial config loaded:', cfg);

    const showToast = (msg, ms=900)=>{ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', ms); };

    // Simple fake homescreen implementation
    function applyFakeHomescreen() {
      console.log('applyFakeHomescreen called');
      console.log('cfg.fakeHomescreen:', cfg.fakeHomescreen);
      console.log('cfg.homescreenImage:', cfg.homescreenImage ? 'Image data present' : 'No image data');
      console.log('Image data starts with:', cfg.homescreenImage ? cfg.homescreenImage.substring(0, 50) : 'N/A');
      
      if (cfg.fakeHomescreen && cfg.homescreenImage) {
        // Set background image with cover sizing for iPhone wallpaper effect
        fakeHomescreen.style.backgroundImage = `url("${cfg.homescreenImage}")`;
        fakeHomescreen.style.display = 'block';
        root.classList.add('fake-active'); // Make root background transparent
        console.log('Fake homescreen enabled');
        console.log('Background image set to:', fakeHomescreen.style.backgroundImage.substring(0, 100));
        console.log('Element display:', fakeHomescreen.style.display);
        console.log('Element computed styles:', window.getComputedStyle(fakeHomescreen).display);
      } else {
        // Hide fake homescreen
        fakeHomescreen.style.display = 'none';
        fakeHomescreen.style.backgroundImage = '';
        root.classList.remove('fake-active'); // Restore root background
        console.log('Fake homescreen disabled');
      }
    }

    // Initialize and refresh on focus
    applyFakeHomescreen();
    window.addEventListener('focus', () => {
      cfg = Storage.load('swipe', defaults);
      applyFakeHomescreen();
    });

    const paint = v => { digitsEl.textContent = (v || '—'); };
    const doFlash = ()=>{ digitsEl.classList.remove('flash'); void digitsEl.offsetWidth; digitsEl.classList.add('flash'); };

    // Start Swipe engine with minimal hooks
    let lastSubmitted = '';

    const hooks = {
      onDigit(d, buffer){ paint(buffer); if(d!=null) doFlash(); },
      onClear(){ paint(''); showToast('Cleared'); },
      onSubmit(value, route){
  lastSubmitted = value || '';
  lastEl.textContent = (value || '—');
        paint('');
        // route can be 'clipboard', 'shortcut', 'clipboard+shortcut', 'clipboard-failed' or 'none'
        if(route && route.indexOf('clipboard') !== -1 && route.indexOf('clipboard-failed') === -1) {
          showToast('Copied to clipboard');
        }
        else if(route === 'clipboard-failed'){
          showToast('Clipboard blocked');
        }
        else if(route && route.indexOf('shortcut') !== -1) showToast('Sent to Shortcut');
        else showToast('Submitted');
      },
      onStatus(msg){ showToast(msg); }
    };

    const swipe = Swipe.start(cfg, hooks);

    // Ensure selection/zooming is reduced on mobile
    document.documentElement.style.webkitTouchCallout='none';
    document.documentElement.style.webkitUserSelect='none';

    // Accessibility: focus root to allow PointerEvents to be captured
    root.tabIndex = -1;
    root.focus();
  </script>

  </body>
  </html>