<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b1020">
  <title>Swipe — Perform</title>
  <link rel="stylesheet" href="../../assets/css/base.css?v=1">
  <style>
    /* perform layout: full-bleed behind status bar, respect safe areas for content */
    .perform-root{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:var(--bg);touch-action:none;-webkit-user-select:none;user-select:none}
    .digits-wrap{display:flex;align-items:center;justify-content:center;pointer-events:none}
    .digits{font-size:4.4rem;letter-spacing:6px;color:rgba(255,255,255,0.95);font-weight:800}
    .last{position:fixed;bottom:calc(8px + env(safe-area-inset-bottom));left:12px;color:rgba(255,255,255,0.7);font-size:0.9rem}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14vh;background:#0f1733;border:1px solid #2a386c;color:var(--text);padding:8px 12px;border-radius:10px;display:none}
    .fake-hint{position:fixed;right:12px;bottom:calc(8px + env(safe-area-inset-bottom));color:rgba(255,255,255,0.6);font-size:0.9rem}
    .perform-root.fake-home{background-size:cover;background-position:center center;background-repeat:no-repeat}
    .flash{animation:flash 240ms ease}
    @keyframes flash{0%{transform:scale(1)}50%{transform:scale(0.96)}100%{transform:scale(1)}}
  </style>
</head>
<body>
  <img id="fakeImg" class="fake-img" aria-hidden="true" alt="" />
  <div id="root" class="perform-root" role="application">
    <div class="digits-wrap">
      <div id="digits" class="digits" aria-live="polite">—</div>
    </div>
  <div id="last" class="last">—</div>
  <!-- fakeHint removed: background image is non-interactive and self-evident -->
    <div id="toast" class="toast" aria-hidden="true">Saved</div>
  </div>

  <script src="../../assets/js/storage.js"></script>
  <script src="../../assets/js/gestures.js"></script>
  <script src="../../assets/js/swipe.js"></script>
  <script>
    // Clean, final Perform page wiring — uses existing Storage, Gestures and Swipe modules.
    const root = document.getElementById('root');
    const digitsEl = document.getElementById('digits');
    const lastEl = document.getElementById('last');
    const toast = document.getElementById('toast');
    const fakeHint = document.getElementById('fakeHint');

    const defaults = { delay:3, shortcut:'', clipboard:false, postShortcut:'', fakeHomescreen:false, homescreenImage:'' };
    let cfg = Storage.load('swipe', defaults);

    const showToast = (msg, ms=900)=>{ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', ms); };

    // Robust fake homescreen: preload the stored DataURL and apply it to
    // the non-interactive <img id="fakeImg"> so it visually fills the
    // screen without affecting input.
    function applyFake(){
      cfg = Object.assign(cfg, Storage.load('swipe', {}));
      const fakeImg = document.getElementById('fakeImg');
      // Reset state
      if(!cfg.fakeHomescreen || !cfg.homescreenImage){
        if(fakeImg){ fakeImg.src = ''; fakeImg.style.display = 'none'; }
          root.classList.remove('fake-home');
          // Make the perform root transparent so the full-bleed image shows through
          try{ root.style.background = 'transparent'; }catch(_){}
        digitsEl.style.fontSize='4.4rem'; digitsEl.style.position='static'; lastEl.style.display='block';
        return;
      }

      // Preload to ensure it's valid before showing
      const loader = new Image();
      loader.onload = ()=>{
        if(fakeImg){ fakeImg.src = cfg.homescreenImage; fakeImg.style.display = 'block'; }
        root.classList.add('fake-home');
        digitsEl.style.fontSize='1.05rem';
        digitsEl.style.position='fixed';
        digitsEl.style.right='12px';
        digitsEl.style.bottom='calc(8px + env(safe-area-inset-bottom))';
        digitsEl.style.pointerEvents='none';
        lastEl.style.display='none';
      };
      loader.onerror = ()=>{
        if(fakeImg){ fakeImg.src = ''; fakeImg.style.display = 'none'; }
        root.classList.remove('fake-home');
          try{ root.style.background = ''; }catch(_){}
        digitsEl.style.fontSize='4.4rem'; digitsEl.style.position='static'; lastEl.style.display='block';
      };
      loader.src = cfg.homescreenImage;
    }

    applyFake();
    window.addEventListener('focus', applyFake);

    const paint = v => { digitsEl.textContent = (v || '—'); };
    const doFlash = ()=>{ digitsEl.classList.remove('flash'); void digitsEl.offsetWidth; digitsEl.classList.add('flash'); };

    // Start Swipe engine with minimal hooks
    let lastSubmitted = '';

    const hooks = {
      onDigit(d, buffer){ paint(buffer); if(d!=null) doFlash(); },
      onClear(){ paint(''); showToast('Cleared'); },
      onSubmit(value, route){
  lastSubmitted = value || '';
  lastEl.textContent = (value || '—');
        paint('');
        // route can be 'clipboard', 'shortcut', 'clipboard+shortcut', 'clipboard-failed' or 'none'
        if(route && route.indexOf('clipboard') !== -1 && route.indexOf('clipboard-failed') === -1) {
          showToast('Copied to clipboard');
        }
        else if(route === 'clipboard-failed'){
          showToast('Clipboard blocked');
        }
        else if(route && route.indexOf('shortcut') !== -1) showToast('Sent to Shortcut');
        else showToast('Submitted');
      },
      onStatus(msg){ showToast(msg); }
    };

    const swipe = Swipe.start(cfg, hooks);

    // Ensure selection/zooming is reduced on mobile
    document.documentElement.style.webkitTouchCallout='none';
    document.documentElement.style.webkitUserSelect='none';

    // Accessibility: focus root to allow PointerEvents to be captured
    root.tabIndex = -1;
    root.focus();
  </script>
  <div class="beta-watermark">Old</div>
  </body>
  </html>