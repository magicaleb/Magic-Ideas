<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Timewarp â€” Perform</title>
  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      width: 100dvw; 
      height: 100dvh; 
      background: #000; 
      overflow: hidden; 
      touch-action: none; 
      -webkit-user-select: none; 
      user-select: none; 
      font-family: -apple-system, system-ui, sans-serif; 
    }
    
    #root { 
      position: fixed; 
      inset: 0; 
      background: #000;
      z-index: 2;
    }
    
    .clock-display {
      position: absolute;
      font-variant-numeric: tabular-nums;
      user-select: none;
      pointer-events: none;
      white-space: nowrap;
      z-index: 3;
    }
    
    .toast { 
      position: fixed; 
      left: 50%; 
      bottom: 28%; 
      transform: translateX(-50%); 
      background: #0f1733; 
      border: 1px solid #2a386c; 
      color: #eef2ff; 
      padding: 8px 12px; 
      border-radius: 10px; 
      display: none; 
      z-index: 4;
    }
  </style>
</head>
<body>
  <!-- Fullscreen background image (same pattern as swipe trick) -->
  <img id="backgroundImg" style="
    position: fixed !important;
    inset: 0 !important;
    width: 100dvw !important;
    height: calc(100dvh + env(safe-area-inset-bottom)) !important;
    object-fit: cover !important;
    pointer-events: none !important;
    z-index: 1 !important;
    display: none !important;
    background: black !important;
    margin-bottom: calc(-1 * env(safe-area-inset-bottom)) !important;
  ">

  <div id="root">
    <!-- Clock display -->
    <div id="clockDisplay" class="clock-display">12:00</div>
    
    <!-- Toast for status messages -->
    <div id="toast" class="toast" aria-hidden="true">Status</div>
  </div>

  <script src="../../assets/js/storage.js?v=1"></script>
  <script src="../../assets/js/gestures.js?v=1"></script>
  <script>
    // Load saved config
    const saved = Storage.load('timewarp', {
      useBackground: false,
      backgroundImage: '',
      fontFamily: '-apple-system, BlinkMacSystemFont, sans-serif',
      fontWeight: '400',
      fontSize: 12,
      letterSpacing: 0,
      verticalOffset: 20,
      horizontalAlignment: 'center',
      clockColor: '#ffffff',
      showAmPm: false,
      rollbackDuration: 1
    });

    // DOM elements
    const root = document.getElementById('root');
    const clockDisplay = document.getElementById('clockDisplay');
    const toast = document.getElementById('toast');
    const backgroundImg = document.getElementById('backgroundImg');

    // State
    let currentDisplayTime = new Date();
    let isRollingBack = false;
    let rollbackTimer = null;
    let realTimeSync = null;
    let swipeBuffer = '';
    let rollingBackWithDelay = false;

    // Utility functions
    const showToast = (msg) => { 
      toast.textContent = msg; 
      toast.style.display = 'block'; 
      setTimeout(() => toast.style.display = 'none', 900); 
    };

    const formatTime = (date, showAmPm = false) => {
      const hours = date.getHours();
      const minutes = date.getMinutes();
      
      if (showAmPm) {
        const displayHours = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);
        const amPm = hours >= 12 ? 'PM' : 'AM';
        const minutesStr = minutes.toString().padStart(2, '0');
        return `${displayHours}:${minutesStr} ${amPm}`;
      } else {
        const displayHours = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);
        const minutesStr = minutes.toString().padStart(2, '0');
        return `${displayHours}:${minutesStr}`;
      }
    };

    const updateClockDisplay = () => {
      const timeStr = formatTime(currentDisplayTime, saved.showAmPm);
      clockDisplay.textContent = timeStr;
    };

    const applyClockStyle = () => {
      clockDisplay.style.fontFamily = saved.fontFamily;
      clockDisplay.style.fontWeight = saved.fontWeight;
      clockDisplay.style.fontSize = saved.fontSize + 'vw';
      clockDisplay.style.letterSpacing = saved.letterSpacing + 'em';
      clockDisplay.style.color = saved.clockColor;
      clockDisplay.style.top = saved.verticalOffset + 'vh';
      
      // Horizontal alignment
      if (saved.horizontalAlignment === 'left') {
        clockDisplay.style.left = '5vw';
        clockDisplay.style.right = 'auto';
        clockDisplay.style.transform = 'translateX(0)';
        clockDisplay.style.textAlign = 'left';
      } else if (saved.horizontalAlignment === 'right') {
        clockDisplay.style.left = 'auto';
        clockDisplay.style.right = '5vw';
        clockDisplay.style.transform = 'translateX(0)';
        clockDisplay.style.textAlign = 'right';
      } else {
        clockDisplay.style.left = '50vw';
        clockDisplay.style.right = 'auto';
        clockDisplay.style.transform = 'translateX(-50%)';
        clockDisplay.style.textAlign = 'center';
      }
    };

    const applyBackground = () => {
      if (saved.useBackground && saved.backgroundImage) {
        backgroundImg.src = saved.backgroundImage;
        backgroundImg.style.display = 'block';
      } else {
        backgroundImg.style.display = 'none';
        backgroundImg.src = '';
      }
    };

    const startRollbackAnimation = () => {
      if (isRollingBack || rollingBackWithDelay) return;
      
      const now = new Date();
      const diffMinutes = Math.floor((currentDisplayTime - now) / (1000 * 60));
      
      if (diffMinutes <= 0) {
        // Already at current time, sync up
        currentDisplayTime = new Date();
        updateClockDisplay();
        startRealTimeSync();
        return;
      }

      rollingBackWithDelay = true;
      showToast('Starting rollback in 5 seconds...');
      
      // 5 second delay before starting rollback
      setTimeout(() => {
        rollingBackWithDelay = false;
        isRollingBack = true;
        
        const totalDuration = saved.rollbackDuration * 1000; // Convert to milliseconds
        const stepInterval = Math.max(40, Math.min(600, totalDuration / diffMinutes)); // Clamp between 40ms and 600ms
        
        showToast(`Rolling back ${diffMinutes} minutes...`);
        
        rollbackTimer = setInterval(() => {
          // Decrement by one minute
          currentDisplayTime.setMinutes(currentDisplayTime.getMinutes() - 1);
          updateClockDisplay();
          
          // Check if we've reached current time
          const newDiff = Math.floor((currentDisplayTime - new Date()) / (1000 * 60));
          if (newDiff <= 0) {
            clearInterval(rollbackTimer);
            isRollingBack = false;
            
            // Sync to exact current time
            currentDisplayTime = new Date();
            updateClockDisplay();
            
            // Start real-time sync
            startRealTimeSync();
            showToast('Time synchronized!');
          }
        }, stepInterval);
      }, 5000);
    };

    const startRealTimeSync = () => {
      if (realTimeSync) clearInterval(realTimeSync);
      
      realTimeSync = setInterval(() => {
        if (!isRollingBack) {
          currentDisplayTime = new Date();
          updateClockDisplay();
        }
      }, 1000); // Update every second for smooth real-time sync
    };

    const stopRealTimeSync = () => {
      if (realTimeSync) {
        clearInterval(realTimeSync);
        realTimeSync = null;
      }
    };

    // Simple digit mapping from swipe angles (like birthday trick)
    const hourMap = { 12:0, 1:1, 2:2, 3:3, 4:4, 5:5, 6:6, 7:7, 8:8, 9:9 };
    
    const toCW = deg => ((deg + 90) % 360 + 360) % 360;       // up=0, CW+
    const cwToHour = cw => ((Math.round(cw/30) % 12) || 12);   // 1..12
    const getDigit = angle => {
      const clockDeg = toCW(angle);
      const hour = cwToHour(clockDeg);
      return hourMap[hour] !== undefined ? hourMap[hour] : null;
    };

    const handleSwipe = (angle) => {
      if (isRollingBack || rollingBackWithDelay) return;
      
      const digit = getDigit(angle);
      if (digit !== null) {
        swipeBuffer += String(digit);
        
        // Auto-submit when we have 1-2 digits (up to 99 minutes)
        const minutes = parseInt(swipeBuffer, 10);
        if (minutes > 0 && swipeBuffer.length <= 2) {
          // Add minutes to current real time
          const now = new Date();
          const futureTime = new Date(now.getTime() + minutes * 60 * 1000);
          
          // Update display time
          currentDisplayTime = futureTime;
          updateClockDisplay();
          
          // Stop real-time sync since we're now in "future" mode
          stopRealTimeSync();
          
          showToast(`Jumped forward ${minutes} minutes`);
          
          // Clear buffer
          swipeBuffer = '';
        }
      }
    };

    const handleTap = () => {
      if (rollingBackWithDelay) {
        // Cancel the pending rollback
        rollingBackWithDelay = false;
        showToast('Rollback cancelled');
        return;
      }
      
      if (isRollingBack) return; // Don't interrupt ongoing rollback
      
      const now = new Date();
      const diffMinutes = Math.floor((currentDisplayTime - now) / (1000 * 60));
      
      if (diffMinutes > 0) {
        // We're in future time, start rollback
        startRollbackAnimation();
      } else {
        // Clear any buffer or just show ready status
        swipeBuffer = '';
        showToast('Ready for input');
      }
    };

    // Initialize display
    const init = () => {
      currentDisplayTime = new Date();
      applyBackground();
      applyClockStyle();
      updateClockDisplay();
      startRealTimeSync();
    };

    // Wire gestures
    Gestures.onSwipe(handleSwipe, root);
    Gestures.onTap(handleTap, root);

    // Prevent context menu and other interactions
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());

    // Initialize everything
    init();

    // Handle visibility changes to keep time in sync
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && !isRollingBack && !rollingBackWithDelay) {
        const now = new Date();
        const diffMinutes = Math.floor((currentDisplayTime - now) / (1000 * 60));
        
        if (Math.abs(diffMinutes) <= 1) {
          // Close enough to real time, sync up
          currentDisplayTime = now;
          updateClockDisplay();
          startRealTimeSync();
        }
      }
    });

    // Debug logging
    console.log('Timewarp initialized with config:', saved);
  </script>
</body>
</html>