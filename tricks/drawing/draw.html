<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Magic Drawing with Progressive Anagrams</title>
  <link rel="stylesheet" href="../../assets/css/base.css?v=1">
  <style>
    /* Drawing app specific styles */
    .drawing-container {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }
    
    .drawing-canvas {
      flex: 1;
      border: none;
      background: #fff;
      touch-action: none;
      cursor: crosshair;
    }
    
    .drawing-controls {
      position: fixed;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 8px;
      z-index: 100;
    }
    
    .drawing-controls button {
      padding: 8px 12px;
      font-size: 0.9rem;
      border-radius: 8px;
      min-width: auto;
    }
    
    .debug-info {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.8rem;
      max-width: 200px;
      display: none;
      z-index: 100;
    }
    
    .debug-info.show {
      display: block;
    }
    
    .anagram-display {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.9);
      color: var(--accent);
      padding: 15px;
      border-radius: 12px;
      font-size: 2rem;
      font-weight: bold;
      min-width: 60px;
      text-align: center;
      display: none;
      z-index: 100;
      border: 2px solid var(--accent);
    }
    
    .anagram-display.show {
      display: block;
    }
    
    .zone-indicator {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      display: none;
      z-index: 99;
      pointer-events: none;
    }
    
    .zone-indicator.show {
      display: block;
    }
    
    .zone-indicator.no {
      top: 20%;
      background: rgba(220, 38, 38, 0.8);
    }
    
    .zone-indicator.yes {
      bottom: 20%;
      background: rgba(34, 197, 94, 0.8);
    }
    
    .toast {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 1rem;
      display: none;
      z-index: 1000;
    }
    
    .toast.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="drawing-container">
    <!-- Drawing Controls -->
    <div class="drawing-controls">
      <button id="debugToggle" class="ghost">Debug: OFF</button>
      <button id="debugButton" class="ghost">DEBUG</button>
      <button id="undoButton" class="ghost">Undo</button>
      <button id="clearButton" class="danger">Clear</button>
    </div>
    
    <!-- Debug Information Panel -->
    <div id="debugInfo" class="debug-info">
      <div><strong>Debug Info:</strong></div>
      <div id="debugWordBank">Word Bank: empty</div>
      <div id="debugAnagramStatus">Anagram: not ready</div>
      <div id="debugTreeStatus">Tree Position: -</div>
      <div id="debugLastAction">Last Action: -</div>
    </div>
    
    <!-- Zone Indicators -->
    <div id="noZone" class="zone-indicator no">NO Zone</div>
    <div id="yesZone" class="zone-indicator yes">YES Zone</div>
    
    <!-- Main Drawing Canvas -->
    <canvas id="drawingCanvas" class="drawing-canvas"></canvas>
    
    <!-- Anagram Letter Display -->
    <div id="anagramDisplay" class="anagram-display">?</div>
    
    <!-- Toast Messages -->
    <div id="toast" class="toast"></div>
  </div>

  <!-- Scripts -->
  <script src="../../assets/js/storage.js"></script>
  <script src="../../assets/js/anagram.js"></script>
  <script>
    // Drawing App with Progressive Anagrams
    class DrawingApp {
      constructor() {
        this.canvas = document.getElementById('drawingCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.isDrawing = false;
        this.debugMode = false;
        this.wordBank = '';
        this.anagramTree = null;
        
        // UI Elements
        this.debugToggle = document.getElementById('debugToggle');
        this.debugButton = document.getElementById('debugButton');
        this.undoButton = document.getElementById('undoButton');
        this.clearButton = document.getElementById('clearButton');
        this.debugInfo = document.getElementById('debugInfo');
        this.anagramDisplay = document.getElementById('anagramDisplay');
        this.toast = document.getElementById('toast');
        this.noZone = document.getElementById('noZone');
        this.yesZone = document.getElementById('yesZone');
        
        this.init();
      }
      
      init() {
        this.setupCanvas();
        this.setupEventListeners();
        this.loadState();
        this.updateDebugInfo();
      }
      
      setupCanvas() {
        // Set canvas size to full window
        this.resizeCanvas();
        window.addEventListener('resize', () => this.resizeCanvas());
        
        // Setup drawing context
        this.ctx.strokeStyle = '#000';
        this.ctx.lineWidth = 2;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
      }
      
      resizeCanvas() {
        const rect = this.canvas.getBoundingClientRect();
        this.canvas.width = rect.width;
        this.canvas.height = rect.height;
      }
      
      setupEventListeners() {
        // Debug toggle
        this.debugToggle.addEventListener('click', () => this.toggleDebugMode());
        
        // Debug button
        this.debugButton.addEventListener('click', () => this.showDebugInfo());
        
        // Undo button
        this.undoButton.addEventListener('click', () => this.undo());
        
        // Clear button
        this.clearButton.addEventListener('click', () => this.clear());
        
        // Canvas drawing events
        this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
        this.canvas.addEventListener('mousemove', (e) => this.draw(e));
        this.canvas.addEventListener('mouseup', () => this.stopDrawing());
        this.canvas.addEventListener('mouseout', () => this.stopDrawing());
        
        // Touch events for mobile
        this.canvas.addEventListener('touchstart', (e) => this.handleTouch(e, 'start'));
        this.canvas.addEventListener('touchmove', (e) => this.handleTouch(e, 'move'));
        this.canvas.addEventListener('touchend', (e) => this.handleTouch(e, 'end'));
        
        // Canvas tap for anagram navigation and clipboard paste
        this.canvas.addEventListener('click', (e) => this.handleCanvasTap(e));
      }
      
      startDrawing(e) {
        this.isDrawing = true;
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        this.ctx.beginPath();
        this.ctx.moveTo(x, y);
      }
      
      draw(e) {
        if (!this.isDrawing) return;
        
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        this.ctx.lineTo(x, y);
        this.ctx.stroke();
      }
      
      stopDrawing() {
        this.isDrawing = false;
        this.ctx.beginPath();
      }
      
      handleTouch(e, type) {
        e.preventDefault();
        
        if (e.touches.length > 1) return; // Ignore multi-touch
        
        const touch = e.touches[0] || e.changedTouches[0];
        const mouseEvent = new MouseEvent(
          type === 'start' ? 'mousedown' : type === 'move' ? 'mousemove' : 'mouseup',
          {
            clientX: touch.clientX,
            clientY: touch.clientY
          }
        );
        
        this.canvas.dispatchEvent(mouseEvent);
      }
      
      async handleCanvasTap(e) {
        // If word bank is empty, try to paste from clipboard
        if (!this.wordBank.trim()) {
          await this.tryPasteFromClipboard();
          return;
        }
        
        // If debug mode is on and anagram tree is ready, handle navigation
        if (this.debugMode && this.anagramTree) {
          this.handleAnagramNavigation(e);
        }
      }
      
      async tryPasteFromClipboard() {
        try {
          const text = await navigator.clipboard.readText();
          if (text && text.trim()) {
            this.wordBank = text.trim();
            this.generateAnagram();
            this.showToast('Pasted from clipboard!');
            this.updateDebugInfo('Successful paste into word bank');
          }
        } catch (err) {
          // Fallback: show prompt for manual input
          const text = prompt('Enter text for anagram generation:');
          if (text && text.trim()) {
            this.wordBank = text.trim();
            this.generateAnagram();
            this.showToast('Text added to word bank!');
            this.updateDebugInfo('Manual input into word bank');
          }
        }
      }
      
      generateAnagram() {
        if (!this.wordBank.trim()) return;
        
        this.anagramTree = ProgressiveAnagram.createFromText(this.wordBank);
        
        if (this.anagramTree && this.anagramTree.root) {
          this.updateDebugInfo('Progressive anagram generated');
          this.updateAnagramDisplay();
          
          if (this.debugMode) {
            this.anagramDisplay.classList.add('show');
          }
        } else {
          this.updateDebugInfo('Failed to generate anagram - no valid words found');
        }
      }
      
      handleAnagramNavigation(e) {
        if (!this.anagramTree) return;
        
        const rect = this.canvas.getBoundingClientRect();
        const y = e.clientY - rect.top;
        const canvasHeight = rect.height;
        
        const upperThird = canvasHeight / 3;
        const lowerThird = canvasHeight * 2 / 3;
        
        let navigated = false;
        
        if (y < upperThird) {
          // Upper third - NO
          navigated = this.anagramTree.navigateNo();
          this.showZoneIndicator('no');
          this.updateDebugInfo('Navigate: NO');
        } else if (y > lowerThird) {
          // Lower third - YES
          navigated = this.anagramTree.navigateYes();
          this.showZoneIndicator('yes');
          this.updateDebugInfo('Navigate: YES');
        }
        
        if (navigated) {
          this.updateAnagramDisplay();
        }
      }
      
      showZoneIndicator(zone) {
        const indicator = zone === 'no' ? this.noZone : this.yesZone;
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 1000);
      }
      
      updateAnagramDisplay() {
        if (!this.anagramTree) return;
        
        if (this.anagramTree.isAtEnd()) {
          const word = this.anagramTree.getCompletedWord();
          this.anagramDisplay.textContent = word.toUpperCase();
        } else {
          const letter = this.anagramTree.getCurrentLetter();
          this.anagramDisplay.textContent = letter.toUpperCase();
        }
      }
      
      toggleDebugMode() {
        this.debugMode = !this.debugMode;
        this.debugToggle.textContent = `Debug: ${this.debugMode ? 'ON' : 'OFF'}`;
        
        if (this.debugMode) {
          this.debugInfo.classList.add('show');
          if (this.anagramTree && this.anagramTree.root) {
            this.anagramDisplay.classList.add('show');
          }
        } else {
          this.debugInfo.classList.remove('show');
          this.anagramDisplay.classList.remove('show');
        }
        
        this.saveState();
      }
      
      showDebugInfo() {
        const info = [];
        info.push(`Word Bank: ${this.wordBank || 'empty'}`);
        info.push(`Anagram Ready: ${this.anagramTree ? 'yes' : 'no'}`);
        if (this.anagramTree) {
          info.push(`Current Letter: ${this.anagramTree.getCurrentLetter() || 'none'}`);
          info.push(`At End: ${this.anagramTree.isAtEnd() ? 'yes' : 'no'}`);
          info.push(`Can Go YES: ${this.anagramTree.canNavigateYes() ? 'yes' : 'no'}`);
          info.push(`Can Go NO: ${this.anagramTree.canNavigateNo() ? 'yes' : 'no'}`);
        }
        
        this.showToast(info.join('\n'));
      }
      
      undo() {
        if (this.anagramTree && this.anagramTree.undo()) {
          this.updateAnagramDisplay();
          this.updateDebugInfo('Undo: returned to previous step');
        }
      }
      
      clear() {
        // Clear canvas
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Clear word bank
        this.wordBank = '';
        
        // Reset anagram tree
        this.anagramTree = null;
        
        // Hide anagram display
        this.anagramDisplay.classList.remove('show');
        
        // Update debug info
        this.updateDebugInfo('Cleared: canvas, word bank, and anagram reset');
        
        this.saveState();
      }
      
      updateDebugInfo(lastAction = null) {
        document.getElementById('debugWordBank').textContent = 
          `Word Bank: ${this.wordBank || 'empty'}`;
        
        document.getElementById('debugAnagramStatus').textContent = 
          `Anagram: ${this.anagramTree ? 'ready' : 'not ready'}`;
        
        let treeStatus = '-';
        if (this.anagramTree) {
          const current = this.anagramTree.getCurrentLetter();
          const isEnd = this.anagramTree.isAtEnd();
          treeStatus = isEnd ? `END: ${this.anagramTree.getCompletedWord()}` : current;
        }
        document.getElementById('debugTreeStatus').textContent = `Tree Position: ${treeStatus}`;
        
        if (lastAction) {
          document.getElementById('debugLastAction').textContent = `Last Action: ${lastAction}`;
        }
      }
      
      showToast(message) {
        this.toast.textContent = message;
        this.toast.classList.add('show');
        setTimeout(() => this.toast.classList.remove('show'), 3000);
      }
      
      saveState() {
        Storage.save('drawingApp', {
          debugMode: this.debugMode,
          wordBank: this.wordBank
        });
      }
      
      loadState() {
        const state = Storage.load('drawingApp', {
          debugMode: false,
          wordBank: ''
        });
        
        this.debugMode = state.debugMode;
        this.wordBank = state.wordBank;
        
        // Update UI
        this.debugToggle.textContent = `Debug: ${this.debugMode ? 'ON' : 'OFF'}`;
        if (this.debugMode) {
          this.debugInfo.classList.add('show');
        }
        
        // Generate anagram if word bank exists
        if (this.wordBank) {
          this.generateAnagram();
        }
      }
    }
    
    // Initialize the drawing app when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      window.drawingAppInstance = new DrawingApp();
    });
  </script>
</body>
</html>